#### 多处理器编程

- 原子性：incq ($rsp)，这个汇编语句在单处理器上是原子性的，因为中断只会发生在汇编语句边缘，但是在多处理器上这条语句并不是原子性的

- 指令重排：

```c
while (!done);
// would be optimized to
if (!done) while (1);
```

- 防止编译优化：

    - 方法一：使用内存屏障

    ```c
    int x = 0;
    void fn() {
        x = 1;
        x = 1; // 这句很可能会被编译器优化掉
    }

    void fn() {
        x = 1;
        asm volatile("" ::: "memory"); // 这一句提示编译器内存会发生改动
        x = 1; // 由于上一句提示了内存会发生改动，因此这里的再赋值不会被编译器优化掉
    }
    ```

    - 方法二：使用volatile关键字

- 处理器间的可见性：

    - cpu的乱序执行

    - 现代cpu使用了超标量流水线技术（多路发射），每个流水段可以并行地处理多条指令

    - 对于如下两个线程，x、y的打印结构可能都是0：

    ```c
    static int x = 0;
    static int y = 0;
    void routine0() {
        x = 1;
        yield();
        sys_write(y);
    }

    void routine1() {
        y = 1;
        yield();
        sys_write(x);
    }
    ```