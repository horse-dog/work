#### 进程的状态机描述

- (M, R), M代表地址空间，R代表寄存器

#### mmap系统调用

- 使用 mmap 系统调用可以将用户空间的虚拟内存地址与文件进行映射（绑定），对映射后的虚拟内存地址进行读写操作就如同对文件进行读写操作一样。

- 读写文件都需要经过 页缓存，所以 mmap 映射的正是文件的 页缓存，而非磁盘中的文件本身。由于 mmap 映射的是文件的 页缓存，所以就涉及到同步的问题，即 页缓存 会在什么时候把数据同步到磁盘。

- Linux 内核并不会主动把 mmap 映射的 页缓存 同步到磁盘，而是需要用户主动触发。同步 mmap 映射的内存到磁盘有 4 个时机：

  - 调用 msync 函数主动进行数据同步（主动）。
  
  - 调用 munmap 函数对文件进行解除映射关系时（主动）。
  
  - 进程退出时（被动）。
  
  - 系统关机时（被动）。

```cpp
void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);
/**
 * addr：指定映射的虚拟内存地址，可以设置为 NULL，让 Linux 内核自动选择合适的虚拟内存
 * length：映射的长度
 * prot：映射内存的保护模式，可选值如下：
 *    PROT_EXEC：可以被执行。
 *    PROT_READ：可以被读取。
 *    PROT_WRITE：可以被写入。
 *    PROT_NONE：不可访问。
 * flags：指定映射的类型，常用的可选值如下：
 *    MAP_FIXED：使用指定的起始虚拟内存地址进行映射。
 *    MAP_SHARED：与其它所有映射到这个文件的进程共享映射空间（可实现共享内存）。
 *    MAP_PRIVATE：建立一个写时复制（Copy on Write）的私有映射空间。
 *    MAP_LOCKED：锁定映射区的页面，从而防止页面被交换出内存。
 * fd：进行映射的文件句柄。
 * offset：文件偏移量（从文件的何处开始映射）。
 */

int munmap(void * addr, size_t len);
int msync(void *addr, size_t len, int flags);
```

#### 修改进程地址空间：

- gdb实现调试的原理：使用ptrace系统调用来与目标程序进行交互。ptrace允许一个进程（调试器）监视和控制另一个进程（目标程序）的执行。

- 通过ptrace系统调用，gdb可以读取和修改目标程序的寄存器、内存和其他调试相关的信息。从而访问和修改目标进程的地址空间。

- 外挂的实现原理：通过多次约束地址的搜索范围，找到想要修改的地址，然后进行操作。